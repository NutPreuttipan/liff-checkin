<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Squard Check-in7</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        button { padding: 15px 30px; margin: 10px; font-size: 18px; cursor: pointer; border-radius: 8px; border: none; color: white; }
        .btn-in { background-color: #28a745; }
        .btn-out { background-color: #dc3545; }
    </style>
</head>
<body>
    <h2>ระบบบันทึกเวลา</h2>
    <div id="user">กำลังโหลดข้อมูล...</div>
    <br>
    <button class="btn-in" onclick="getLocation('Check-in')">Check-in</button>
    <button class="btn-out" onclick="calDistance('Check-out', 13.6738966, 100.5446342)">Check-out</button>

    <script>
        const LIFF_ID = '2008881601-Dg4CmxGP';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwbtc0Kg_P0TQ0yiEe_jb8-3yLvhNqoUlronJ_rDsukQEEsCYzVJS73BOJWZbyjXhGoUA/exec';

        async function main() {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('user').innerText = "สวัสดีคุณ " + profile.displayName;
            } else {
                liff.login();
            }
        }
        main();

        function getLocation(type) {
            if (confirm('ยืนยันการ ' + type)) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    calDistance(type, lat, lng);
                }, (err) => {
                    alert('กรุณาอนุญาตการเข้าถึง GPS');
                });
            }
        }

        function calDistance(type, lat, lng) {
            var workLat = 13.6770737;
            var workLng = 100.5445285;
            var R = 6371; // รัศมีโลก (กิโลเมตร)
            var dLat = (workLat - lat) * Math.PI / 180;
            var dLon = (workLng - lng) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat * Math.PI / 180) * Math.cos(workLat * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            var distance = R * c * 1000 // ค่าเป็นเมตร
            if (distance < 500) {
                sendData(type, lat, lng);
            } else {
                alert('อยู่นอกระยะที่กำหนด');
                liff.closeWindow();
            }
        }

        async function sendData(type, lat, lng) {
            const profile = await liff.getProfile();
            const callbackName = 'check_in_out_callback_' + Math.round(100000 * Math.random());
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                
                if (data.status === 'success') {
                    alert(data.message);
                    liff.closeWindow();
                } else {
                    alert('เกิดข้อผิดพลาด: ' + data.message);
                }
            };
    
            const fullUrl = GAS_URL + 
                '?callback=' + callbackName +
                '&type=' + encodeURIComponent(type) +
                '&userId=' + encodeURIComponent(profile.userId) +
                '&lat=' + encodeURIComponent(lat) +
                '&lng=' + encodeURIComponent(lng);
    
            const script = document.createElement('script');
            script.src = fullUrl;
            document.body.appendChild(script);
        }
    </script>
</body>
</html>






































